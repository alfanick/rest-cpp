#!/usr/bin/python

import sys, os, string, re

class Template(string.Template):
    delimiter = '%'

Makefile = """address?=0.0.0.0
port?=8080
workers?=4
dispatcher?=lc

CXX=/usr/bin/clang++ -Wall -std=c++11 -stdlib=libc++ -O2
INCLUDES=
LIBRARY=-lrestcpp -DSERVER_BIND=$(address) -DSERVER_PORT=$(port) -DSERVER_WORKERS=$(workers) -DSERVER_DISPATCHER_$(dispatcher)

ifneq ($(shell uname),Darwin)
CXX=g++ -std=gnu++11 -Wall -pthread -O2
endif

.PHONY: server build
default: server

server: build
\t@DYLD_LIBRARY_PATH=/usr/local/lib LD_LIBRARY_PATH=/usr/local/lib ./%name

build:
\t@$(CXX) $(INCLUDES) *.cpp -o %name $(LIBRARY)

"""

init_cpp = """#include <rest/rest.h>

create_json_service(hello_world) {
  service->response->data["result"] = "Hello world!";
}

void routes(REST::Router* r) {
  r->match("/", hello_world);
}

"""

_inline_cpp = """%router->match("%uri", [](REST::Service* service) {
  throw REST::HTTP::NotImplemented();
});"""

_simple_service_cpp = """create_service(%name) {
  throw REST::HTTP::NotImplemented();
}"""

_json_simple_service_cpp = """create_json_service(%name) {
  throw REST::HTTP::NotImplemented();
}"""

_simple_service_route = '  %router->match("%uri", %name);'

resource_cpp = """class %name : public REST::Resource {
  void read() {
    throw REST::HTTP::NotImplemented();
  }
}"""

service_cpp = """class %name : public REST::Resource {
  void method(REST::Request::Method type) {
    throw REST::HTTP::NotImplemented();
  }
}"""

FILES_LIST = (("Makefile", Makefile), ("init.cpp", init_cpp))

def snake(name):
    s1 = re.sub('(.)([A-Z][a-z]+)', r'\1_\2', name.replace('-', '_'))
    return re.sub('([a-z0-9])([A-Z])', r'\1_\2', s1).lower()

def cmd_new(directory):
    full_directory = os.path.abspath(directory)
    name = snake(os.path.basename(full_directory))

    print("rest-cpp project: %s" % name)

    # ensure directory exists
    if not os.path.isdir(full_directory):
        os.makedirs(full_directory)
        print("  creating directory: %s " % directory)

    for (filename, content) in FILES_LIST:
        full_name = os.path.join(full_directory, filename)

        if not os.path.isfile(full_name):
            print("  creating file: %s" % os.path.join(directory, filename))
            content = Template(content).substitute(name=name)

            with open(full_name, "w") as f:
                f.write(content)
        else:
            print("  skipping file: %s" % os.path.join(directory, filename))

    print("Done. Have fun!")

ROUTER_VAR = 'r'

def new_lambda():
    pass

def new_simple_service():
    pass

def new_json_simple_service():
    pass

def new_resource():
    pass

def new_resources():
    pass

def new_service():
    pass

GENERATE_ACTIONS = {
    'inline' : new_lambda,
    'i': new_lambda,
    'service' : new_service,
    's': new_service,
    'resource': new_resource,
    'resources': new_resources,
    'r': new_resources,
    'simple': new_simple_service,
    'json': new_json_simple_service,
    'j': new_json_simple_service
}

def cmd_generate():
    if not (os.path.isfile("Makefile") and os.path.isfile("init.cpp")):
        print("You must be in rest-cpp project root.")
        sys.exit(1)
    if len(sys.argv) == 2:
        print("You need to provide what to generate.")
        sys.exit(1)
    try:
        action = GENERATE_ACTIONS[sys.argv[2]]
    except:
        print("You need to provide right action (inline/service/resource/resources/simple/json)")
        sys.exit(1)

    action()

def cmd_help():
    print("rest-cpp")
    print("REST-like framework and server for blazing fast web applications in C++11.\n")
    print("Commands")
    print("  - new [directory] - create new project or update files")
    print("  - (b)uild - build binary")
    print("  - (s)erver - build and start server")
    print("  - help - show this message")

SHORTCUTS = {'g' : 'generate', 'b' : 'build', 's' : 'server'}

if __name__ == "__main__":
    directory = "."

    if len(sys.argv) == 1:
        cmd_help()
        sys.exit(1)
    elif len(sys.argv) > 1:
        for k,v in SHORTCUTS.iteritems():
            if k == sys.argv[1]:
                sys.argv[1] = v
                break

        if sys.argv[1] == "new":
            if len(sys.argv) == 3:
                directory = sys.argv[2]

            cmd_new(directory)
        elif sys.argv[1] == "build" or sys.argv[1] == "server":
            if os.path.isfile("Makefile"):
                os.execvp("make", sys.argv)
            else:
                print("Not in rest-cpp project directory.")
                sys.exit(1)
        elif sys.argv[1] == "generate":
            cmd_generate()
        else:
            cmd_help()
            sys.exit(1)
